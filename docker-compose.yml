# OpenClaw - Coolify VPS Deployment
# Compatible with Coolify's Docker Compose deployment system

services:
  # ===========================================
  # MAIN OPENCLAW SERVICE
  # ===========================================
  openclaw:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: openclaw-main
    restart: unless-stopped

    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '0.25'
          memory: 256M

    security_opt:
      - no-new-privileges:true

    volumes:
      - openclaw_data:/home/openclaw/data
      - openclaw_config:/home/openclaw/.openclaw
      - openclaw_workspace:/home/openclaw/workspace
      - approval_queue:/home/openclaw/approval-queue

    environment:
      - NODE_ENV=production
      - OPENCLAW_WORKSPACE=/home/openclaw/workspace
      - APPROVAL_QUEUE_PATH=/home/openclaw/approval-queue
      - TZ=${TZ:-UTC}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENCLAW_AI_PROVIDER=anthropic
      - PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium
      - CHROME_NO_SANDBOX=true

    networks:
      - openclaw_internal

    healthcheck:
      test: ["CMD", "pgrep", "-f", "openclaw"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    labels:
      - "coolify.managed=true"
      - "traefik.enable=false"

  # ===========================================
  # TELEGRAM BOT SERVICE
  # ===========================================
  telegram-bot:
    build:
      context: ./telegram-bot
      dockerfile: Dockerfile
    container_name: openclaw-telegram
    restart: unless-stopped

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M

    security_opt:
      - no-new-privileges:true

    volumes:
      - openclaw_data:/data:ro
      - approval_queue:/approval-queue

    environment:
      - NODE_ENV=production
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_ADMIN_ID=${TELEGRAM_ADMIN_ID}
      - TELEGRAM_ALLOWED_CHATS=${TELEGRAM_ALLOWED_CHATS:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - FREEPIK_API_KEY=${FREEPIK_API_KEY:-}
      - INSTAGRAM_ACCESS_TOKEN=${INSTAGRAM_ACCESS_TOKEN:-}
      - APPROVAL_QUEUE_PATH=/approval-queue
      - DATA_PATH=/data

    networks:
      - openclaw_internal

    depends_on:
      openclaw:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "node", "healthcheck.js"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

    labels:
      - "coolify.managed=true"
      - "traefik.enable=false"

  # ===========================================
  # INSTAGRAM SERVICE
  # ===========================================
  instagram-service:
    build:
      context: ./instagram-service
      dockerfile: Dockerfile
    container_name: openclaw-instagram
    restart: unless-stopped

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M

    security_opt:
      - no-new-privileges:true

    volumes:
      - approval_queue:/approval-queue

    environment:
      - NODE_ENV=production
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - INSTAGRAM_ACCESS_TOKEN=${INSTAGRAM_ACCESS_TOKEN:-}
      - INSTAGRAM_BUSINESS_ACCOUNT_ID=${INSTAGRAM_BUSINESS_ACCOUNT_ID:-}
      - INSTAGRAM_APP_ID=${INSTAGRAM_APP_ID:-}
      - INSTAGRAM_APP_SECRET=${INSTAGRAM_APP_SECRET:-}
      - FREEPIK_API_KEY=${FREEPIK_API_KEY:-}
      - MAX_POSTS_PER_DAY=${MAX_POSTS_PER_DAY:-10}
      - APPROVAL_QUEUE_PATH=/approval-queue

    networks:
      - openclaw_internal

    depends_on:
      - telegram-bot

    healthcheck:
      test: ["CMD", "node", "healthcheck.js"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

    labels:
      - "coolify.managed=true"
      - "traefik.enable=false"

  # ===========================================
  # WEB DASHBOARD (Optional)
  # ===========================================
  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    container_name: openclaw-dashboard
    restart: unless-stopped

    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M

    security_opt:
      - no-new-privileges:true

    volumes:
      - approval_queue:/approval-queue:ro
      - openclaw_data:/data:ro

    environment:
      - NODE_ENV=production
      - PORT=3000
      - DASHBOARD_AUTH_TOKEN=${DASHBOARD_AUTH_TOKEN:-}
      - APPROVAL_QUEUE_PATH=/approval-queue

    networks:
      - openclaw_internal

    depends_on:
      - telegram-bot

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    labels:
      - "coolify.managed=true"
      - "traefik.enable=true"
      - "traefik.http.routers.openclaw-dashboard.entrypoints=https"
      - "traefik.http.routers.openclaw-dashboard.tls=true"
      - "traefik.http.services.openclaw-dashboard.loadbalancer.server.port=3000"

# ===========================================
# NETWORKS
# ===========================================
networks:
  openclaw_internal:
    driver: bridge

# ===========================================
# VOLUMES
# ===========================================
volumes:
  openclaw_data:
    driver: local
  openclaw_config:
    driver: local
  openclaw_workspace:
    driver: local
  approval_queue:
    driver: local
